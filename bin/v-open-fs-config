#!/bin/bash
# info: open config
# options: CONFIG
#
# example: v-open-fs-config /etc/mysql/my.cnf
#
# This function opens/reads config files on the file system
#
# code used in:
#
# bin/v-log-action
# web/edit/server/apache2/index.php
# web/edit/server/bind9/index.php
# web/edit/server/clamav-daemon/index.php
# web/edit/server/crond/index.php
# web/edit/server/cron/index.php
# web/edit/server/dovecot/index.php
# web/edit/server/exim4/index.php
# web/edit/server/exim/index.php
# web/edit/server/fail2ban/index.php
# web/edit/server/hestiaweb/index.php
# web/edit/server/httpd/index.php
# web/edit/server/mariadb/index.php
# web/edit/server/mysqld/index.php
# web/edit/server/mysql/index.php
# web/edit/server/named/index.php
# web/edit/server/nginx/index.php
# web/edit/server/php5-fpm/index.php
# web/edit/server/php-fpm/index.php
# web/edit/server/php/index.php
# web/edit/server/postgresql/index.php
# web/edit/server/proftpd/index.php
# web/edit/server/spamassassin/index.php
# web/edit/server/spamd/index.php
# web/edit/server/ssh/index.php
# web/edit/server/vsftpd/index.php

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
src_file=$1

# Checking arguments
if [ -z "$src_file" ]; then
	echo "Usage: CONFIG"
	exit 1
fi

# Checking root permissions
if [ "$(id -u)" != '0' ]; then
	echo "Error: Script can be run executed only by root"
	exit 10
fi

# Checking file on fs
if [ ! -e "$src_file" ]; then
	echo "Error: $src_file file doesn't exist"
	exit 3
fi

# Checking path
if [ -n "$src_file" ]; then
	rpath=$(readlink -f "$src_file")
	services="nginx|apache|httpd|php|ftp|bind|named|exim|dovecot|spamassassin"
	services="$services|clam|mysql|postgresql|pgsql|cron|ssh|fail2ban|iptables"
	services="$services|my.cnf|hestiaweb"
	spath=$(echo "$rpath" | egrep "$services")
	if [ -z "$spath" ]; then
		echo "Error: invalid source path $src_file"
		exit 2
	fi
	spath=$(echo "$rpath" | egrep "/etc|/var/lib|/var/spool/cron/")
	if [ -z "$spath" ]; then
		echo "Error: invalid source path $src_file"
		exit 2
	fi
fi

# Reading conf
cat "$src_file" 2> /dev/null
if [ $? -ne 0 ]; then
	echo "Error: file $src_file was not opened"
	exit 3
fi

$BIN/v-log-action "system" "Info" "System" "Configuration file opened (File: $src_file)."

# Exiting
exit
